# 万方商事 B2B 采购门户 - 事件驱动架构文档

## 概述

本文档描述了万方商事 B2B 采购门户项目中实施的事件驱动架构系统。该系统提供了解耦的业务逻辑处理、异步任务处理、实时监控和完整的调试能力。

## 架构组件

### 1. 核心接口和抽象类

#### EventInterface
- **位置**: `app/Events/Contracts/EventInterface.php`
- **功能**: 定义事件的基本接口
- **主要方法**:
  - `getName()`: 获取事件名称
  - `getData()`: 获取事件数据
  - `getTimestamp()`: 获取事件时间戳
  - `shouldProcessAsync()`: 是否异步处理
  - `getPriority()`: 获取事件优先级

#### ListenerInterface
- **位置**: `app/Events/Contracts/ListenerInterface.php`
- **功能**: 定义事件监听器接口
- **主要方法**:
  - `handle()`: 处理事件
  - `shouldHandle()`: 是否处理特定事件
  - `getPriority()`: 获取监听器优先级
  - `stopPropagation()`: 停止事件传播

#### AbstractEvent
- **位置**: `app/Events/AbstractEvent.php`
- **功能**: 事件基类，提供通用功能
- **特性**:
  - 自动生成唯一ID
  - 支持序列化和反序列化
  - 元数据管理
  - 数据字段访问方法

#### AbstractListener
- **位置**: `app/Events/AbstractListener.php`
- **功能**: 监听器基类，提供通用功能
- **特性**:
  - 安全的事件处理
  - 统一的日志记录
  - 错误处理机制

### 2. 事件调度器

#### EventDispatcher
- **位置**: `app/Events/EventDispatcher.php`
- **功能**: 核心事件调度器
- **主要功能**:
  - 监听器注册和管理
  - 同步/异步事件分发
  - 事件历史记录
  - 优先级处理
  - 传播控制

### 3. 事件服务

#### EventService
- **位置**: `app/Services/EventService.php`
- **功能**: 事件系统门面
- **主要功能**:
  - 统一的事件分发接口
  - 默认监听器注册
  - 系统启用/禁用控制
  - 统计信息收集
  - 调试信息提供

## 业务事件

### 用户事件

#### UserRegisteredEvent
- **触发时机**: 用户注册成功后
- **数据**: 用户ID、用户名、邮箱、注册IP等
- **用途**: 发送欢迎邮件、更新统计、记录日志

#### UserLoggedInEvent
- **触发时机**: 用户登录成功后
- **数据**: 用户ID、登录IP、用户代理等
- **用途**: 安全日志、用户活动追踪

#### UserUpdatedEvent
- **触发时机**: 用户信息更新后
- **数据**: 用户ID、变更字段、原始数据等
- **用途**: 缓存更新、审计日志

### 订单事件

#### OrderCreatedEvent
- **触发时机**: 订单创建成功后
- **数据**: 订单ID、订单项、总金额等
- **用途**: 库存扣减、邮件通知、统计更新

#### OrderStatusChangedEvent
- **触发时机**: 订单状态变更时
- **数据**: 订单ID、旧状态、新状态、变更原因
- **用途**: 状态通知、物流更新

#### OrderCancelledEvent
- **触发时机**: 订单取消时
- **数据**: 订单ID、取消原因、是否需要退款
- **用途**: 库存恢复、退款处理

### 产品事件

#### ProductCreatedEvent
- **触发时机**: 产品创建后
- **数据**: 产品ID、SKU、价格、库存等
- **用途**: 缓存预热、索引更新

#### ProductUpdatedEvent
- **触发时机**: 产品信息更新后
- **数据**: 产品ID、变更字段、库存变化
- **用途**: 缓存更新、库存管理

#### ProductViewedEvent
- **触发时机**: 产品详情查看时
- **数据**: 产品ID、查看者信息、会话ID
- **用途**: 浏览统计、推荐算法

### 询价事件

#### InquiryCreatedEvent
- **触发时机**: 询价创建后
- **数据**: 询价ID、公司信息、预算、优先级
- **用途**: 销售通知、跟进提醒

#### InquiryStatusChangedEvent
- **触发时机**: 询价状态变更时
- **数据**: 询价ID、状态变更、处理人
- **用途**: 状态通知、业务流程控制

## 事件监听器

### EmailNotificationListener
- **优先级**: 10
- **功能**: 发送各种业务邮件
- **支持事件**: 用户注册、订单创建、状态变更、询价等
- **特性**:
  - 模板化邮件
  - 多语言支持
  - 失败重试

### CacheUpdateListener
- **优先级**: 8
- **功能**: 智能缓存管理
- **支持事件**: 产品更新、订单创建、用户更新
- **特性**:
  - 模式匹配清除
  - 缓存预热
  - 依赖关系处理

### LoggingListener
- **优先级**: 1
- **功能**: 全局事件日志记录
- **支持事件**: 所有事件
- **特性**:
  - 结构化日志
  - 不同级别日志
  - 性能友好

### StatisticsListener
- **优先级**: 5
- **功能**: 业务统计更新
- **支持事件**: 用户注册、订单创建、询价、产品浏览
- **特性**:
  - 实时统计
  - 多维度分析
  - 缓存优化

### InventoryListener
- **优先级**: 7
- **功能**: 库存管理和监控
- **支持事件**: 订单创建、订单取消、产品更新
- **特性**:
  - 库存变化追踪
  - 低库存警报
  - 自动补货提醒

## 异步处理

### ProcessEventJob
- **位置**: `app/Jobs/ProcessEventJob.php`
- **功能**: 异步事件处理任务
- **特性**:
  - 队列优先级
  - 失败重试
  - 唯一性保证
  - 超时控制

### 中间件

#### RateLimitedEventsMiddleware
- **功能**: 事件速率限制
- **特性**:
  - 基于优先级的限制
  - Redis 存储
  - 自动释放

#### EventThrottlingMiddleware
- **功能**: 事件节流控制
- **特性**:
  - 细粒度控制
  - 动态调整
  - 内存友好

## 监控和调试

### EventMonitorService
- **位置**: `app/Services/EventMonitorService.php`
- **功能**: 事件系统监控
- **特性**:
  - 实时指标收集
  - 性能分析
  - 瓶颈识别
  - 内存使用监控

### 监控指标
- **事件统计**: 总数、类型分布、异步/同步比例
- **性能指标**: 处理时间、内存使用、吞吐量
- **错误监控**: 失败率、重试次数、错误分类

### API 端点
```
GET /api/events/statistics     - 事件统计信息
GET /api/events/history        - 事件历史记录
GET /api/events/monitoring     - 监控报告
GET /api/events/performance    - 性能分析
GET /api/events/realtime       - 实时指标
GET /api/events/debug          - 调试信息
POST /api/events/toggle        - 启用/禁用系统
```

## 数据库支持

### inventory_changes 表
- **用途**: 记录库存变化历史
- **字段**: 产品ID、旧库存、新库存、变更类型、原因

### failed_events 表
- **用途**: 记录失败的事件
- **字段**: 事件ID、事件名称、错误信息、重试次数

## 配置和优化

### 队列配置
```php
// config/queue.php
'connections' => [
    'redis' => [
        'driver' => 'redis',
        'connection' => 'default',
        'queue' => [
            'events-high' => 'events-high',
            'events-medium' => 'events-medium',
            'events-low' => 'events-low',
        ],
    ],
],
```

### 缓存配置
```php
// 事件缓存键模式
stats:events:{event_name}:count
stats:events:{event_name}:avg_time
metrics:events:{event_name}:*
```

### 性能优化建议

1. **事件优先级**
   - 高优先级: 用户注册、订单创建 (10)
   - 中优先级: 库存更新、状态变更 (5-8)
   - 低优先级: 产品浏览、统计更新 (1-4)

2. **异步处理**
   - 邮件通知: 异步处理
   - 统计更新: 异步处理
   - 缓存更新: 同步处理

3. **内存优化**
   - 事件数据最小化
   - 及时释放大对象
   - 使用生成器处理大数据集

## 测试覆盖

### 单元测试
- **文件**: `tests/Unit/Events/EventSystemTest.php`
- **覆盖**: 核心事件系统功能
- **测试内容**:
  - 事件注册和分发
  - 监听器优先级
  - 事件传播控制
  - 异步处理
  - 错误处理

### 集成测试
- **文件**: `tests/Feature/Events/EventIntegrationTest.php`
- **覆盖**: 业务流程集成
- **测试内容**:
  - 用户注册流程
  - 订单创建流程
  - 产品浏览统计
  - 缓存更新
  - 邮件发送

## 最佳实践

### 事件设计
1. **单一职责**: 每个事件只代表一个业务概念
2. **不可变性**: 事件数据创建后不应修改
3. **序列化支持**: 确保事件可以序列化
4. **元数据丰富**: 提供足够的上下文信息

### 监听器设计
1. **幂等性**: 监听器应该是幂等的
2. **错误隔离**: 监听器错误不应影响其他监听器
3. **性能考虑**: 避免在监听器中执行耗时操作
4. **日志记录**: 记录关键操作和错误

### 系统维护
1. **定期清理**: 清理过期的事件历史和失败记录
2. **性能监控**: 监控事件处理性能和系统资源使用
3. **容量规划**: 根据业务增长调整队列和缓存配置
4. **文档更新**: 及时更新事件和监听器文档

## 故障排除

### 常见问题

1. **事件未被处理**
   - 检查事件系统是否启用
   - 验证监听器是否正确注册
   - 查看日志中的错误信息

2. **异步事件失败**
   - 检查队列连接状态
   - 查看失败任务表
   - 验证事件序列化是否正常

3. **性能问题**
   - 检查监听器执行时间
   - 分析内存使用情况
   - 调整事件优先级

4. **缓存问题**
   - 验证缓存配置
   - 检查缓存键模式
   - 清理过期缓存数据

### 调试工具

1. **事件历史**: `/api/events/history`
2. **系统调试**: `/api/events/debug`
3. **性能分析**: `/api/events/performance`
4. **实时监控**: `/api/events/realtime`

## 扩展指南

### 添加新事件
1. 继承 `AbstractEvent`
2. 定义事件数据和方法
3. 在业务逻辑中触发事件
4. 编写单元测试

### 添加新监听器
1. 继承 `AbstractListener`
2. 实现 `handle` 方法
3. 注册监听器到事件
4. 编写集成测试

### 自定义中间件
1. 实现 `Illuminate\Queue\Jobs\Job` 中间件接口
2. 在 `ProcessEventJob` 中注册
3. 测试中间件功能

## 版本历史

### v1.0.0 (2025-12-04)
- 初始版本发布
- 完整的事件驱动架构实现
- 核心业务事件支持
- 异步处理和队列集成
- 监控和调试功能
- 完整的测试覆盖

---

**维护团队**: 万方商事技术部  
**最后更新**: 2025年12月4日  
**文档版本**: 1.0.0